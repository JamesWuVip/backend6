name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, staging ]
  pull_request:
    branches: [ main, dev, staging ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # æµ‹è¯•é˜¶æ®µ
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/dev'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: wanli_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Wait for MySQL
      run: |
        until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptest_password --silent; do
          echo 'Waiting for MySQL...'
          sleep 2
        done
    
    - name: Run unit tests
      run: |
        mvn clean test \
          -Dspring.profiles.active=unit-test \
          '-Dtest=!*IntegrationTest,!*E2ETest,!*SecurityTest'
    
    - name: Run integration tests
      run: |
        mvn test \
          -Dspring.profiles.active=integration \
          -Dspring.datasource.url=jdbc:mysql://localhost:3306/wanli_test \
          -Dspring.datasource.username=root \
          -Dspring.datasource.password=password \
          -Dspring.data.redis.host=localhost \
          -Dspring.data.redis.port=6379 \
          -Dtest="*IntegrationTest,DatabaseConnectionTest"
    
    - name: Generate test report
      run: mvn jacoco:report
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella

  # å®‰å…¨æ‰«æ
  security:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/dev'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/maven@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: java
    
    - name: Build for CodeQL
      run: mvn compile -DskipTests
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build JAR
      run: mvn clean package -DskipTests -Dspring.profiles.active=dev
    
    - name: Deploy to Railway (Dev)
      run: |
        curl -fsSL https://railway.app/install.sh | sh
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway environment dev
        railway up --service ${{ secrets.RAILWAY_SERVICE_NAME_DEV }}
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Run database migrations
      run: |
        railway run --service ${{ secrets.RAILWAY_SERVICE_NAME_DEV }} -- \
          mvn flyway:migrate \
          -Dflyway.url=${{ secrets.DEV_DATABASE_URL }} \
          -Dflyway.user=${{ secrets.DEV_DB_USERNAME }} \
          -Dflyway.password=${{ secrets.DEV_DB_PASSWORD }}
    
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ secrets.DEV_APP_URL }}/api/actuator/health || exit 1

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build JAR
      run: mvn clean package -DskipTests -Dspring.profiles.active=staging
    
    - name: Deploy to Railway (Staging)
      run: |
        curl -fsSL https://railway.app/install.sh | sh
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway environment staging
        railway up --service ${{ secrets.RAILWAY_SERVICE_NAME_STAGING }}
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Run database migrations
      run: |
        railway run --service ${{ secrets.RAILWAY_SERVICE_NAME_STAGING }} -- \
          mvn flyway:migrate \
          -Dflyway.url=${{ secrets.STAGING_DATABASE_URL }} \
          -Dflyway.user=${{ secrets.STAGING_DB_USERNAME }} \
          -Dflyway.password=${{ secrets.STAGING_DB_PASSWORD }}
    
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ secrets.STAGING_APP_URL }}/api/actuator/health || exit 1
    
    - name: Run E2E tests
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•
        echo "Running E2E tests against staging environment"
        # mvn test -Dtest=E2ETest -Dapp.url=${{ secrets.STAGING_APP_URL }}
    
    - name: Performance tests
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½æµ‹è¯•
        echo "Running performance tests"
        # å¯ä»¥ä½¿ç”¨ JMeter æˆ–å…¶ä»–æ€§èƒ½æµ‹è¯•å·¥å…·

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build JAR
      run: mvn clean package -DskipTests -Dspring.profiles.active=prod
    
    - name: Deploy to Railway (Production)
      run: |
        curl -fsSL https://railway.app/install.sh | sh
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway environment production
        railway up --service ${{ secrets.RAILWAY_SERVICE_NAME_PROD }}
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Run database migrations
      run: |
        railway run --service ${{ secrets.RAILWAY_SERVICE_NAME_PROD }} -- \
          mvn flyway:migrate \
          -Dflyway.url=${{ secrets.PROD_DATABASE_URL }} \
          -Dflyway.user=${{ secrets.PROD_DB_USERNAME }} \
          -Dflyway.password=${{ secrets.PROD_DB_PASSWORD }}
    
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ secrets.PROD_APP_URL }}/api/actuator/health || exit 1
    
    - name: Notify deployment
      if: success()
      run: |
        echo "Production deployment successful!"
        # è¿™é‡Œå¯ä»¥æ·»åŠ  Slack é€šçŸ¥æˆ–å…¶ä»–é€šçŸ¥æ–¹å¼
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš€ Production deployment successful!"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}